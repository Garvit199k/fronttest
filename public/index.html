<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Professional Typing Test</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="theme-male">
  <div class="container">
    <header>
      <h1>Typing Test</h1>
      <div class="theme-selector">
        <label for="theme">Choose Theme:</label>
        <select id="theme">
          <option value="cute">Cute</option>
          <option value="pastel">Pastel</option>
          <option value="soft">Soft</option>
          <option value="calm">Calm</option>
          <option value="dark">Dark</option>
        </select>
      </div>
      <nav>
        <button id="nav-login" class="nav-btn active">Login</button>
        <button id="nav-register" class="nav-btn">Register</button>
        <button id="nav-leaderboard" class="nav-btn">Leaderboard</button>
        <button id="nav-about" class="nav-btn">About</button>
      </nav>
    </header>
    <main>
      <section id="login-section" class="auth-section">
        <h2>Login</h2>
        <form id="login-form">
          <label for="login-username">Username</label>
          <input type="text" id="login-username" placeholder="Enter your username" required />
          <label for="login-password">Password</label>
          <input type="password" id="login-password" placeholder="Enter your password" required />
          <label for="login-theme">Choose Theme:</label>
          <select id="login-theme" required>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="cute">Cute</option>
            <option value="pastel">Pastel</option>
            <option value="soft">Soft</option>
            <option value="calm">Calm</option>
            <option value="dark">Dark</option>
          </select>
          <button type="submit" class="btn-primary">Login</button>
        </form>
        <div id="login-message" class="auth-message"></div>
      </section>
      <section id="register-section" class="auth-section" style="display:none;">
        <h2>Register</h2>
        <form id="register-form">
          <label for="register-username">Username</label>
          <input type="text" id="register-username" placeholder="Choose a username" required />
          <label for="register-password">Password</label>
          <input type="password" id="register-password" placeholder="Choose a password" required />
          <label for="register-theme">Choose Theme:</label>
          <select id="register-theme" required>
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
          <button type="submit" class="btn-primary">Register</button>
        </form>
        <div id="register-message" class="auth-message"></div>
      </section>
      <div id="authenticated-area" style="display:none;">
        <section id="test-container">
          <div id="test-text" class="test-text"></div>
          <textarea id="input-area" placeholder="Start typing here..." autofocus></textarea>
      <div class="stats">
        <div>Time Left: <span id="time-left">60</span>s</div>
        <div>
          Set Time:
          <select id="time-option">
            <option value="30">30 seconds</option>
            <option value="60" selected>60 seconds</option>
            <option value="120">2 minutes</option>
            <option value="300">5 minutes</option>
          </select>
        </div>
        <div>
          Mode:
          <select id="mode-option">
            <option value="normal" selected>Normal</option>
            <option value="race">Race</option>
          </select>
        </div>
        <div>
          Sound:
          <input type="checkbox" id="sound-toggle" checked />
        </div>
      </div>
      <div id="race-progress" style="display:none; margin-bottom: 1rem;">
        <div>Opponent Progress:</div>
        <progress id="opponent-progress-bar" value="0" max="100" style="width: 100%; height: 20px;"></progress>
      </div>
      <div id="achievement-display" style="margin-bottom: 1rem; font-weight: bold; color: #ff1493;"></div>
      <button id="restart-btn">Restart Test</button>
      <div id="result" class="result"></div>
              </select>
            </div>
            <div>WPM: <span id="wpm">0</span></div>
            <div>Accuracy: <span id="accuracy">100</span>%</div>
            <div>Errors: <span id="errors">0</span></div>
          </div>
      <button id="restart-btn">Restart Test</button>
      <div id="result" class="result"></div>
    </section>
    <section id="leaderboard-section">
      <h2>Leaderboard</h2>
      <table id="leaderboard-table">
        <thead>
          <tr>
            <th>Rank</th>
            <th>Username</th>
            <th>WPM</th>
            <th>Accuracy</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
          <!-- Leaderboard entries will be inserted here -->
        </tbody>
      </table>
    </section>
      </div>
      <section id="about-section" style="display:none;">
        <h2>About</h2>
        <p>This typing test application includes the following features:</p>
        <ul>
          <li>Separate login and registration views for better user experience.</li>
          <li>Multiple themes to choose from, including a new dark theme.</li>
          <li>Leaderboard to track top performers by WPM and accuracy.</li>
          <li>Customizable test durations with options in seconds and minutes.</li>
          <li>Real-time stats including WPM, accuracy, errors, and time left.</li>
          <li>Developed by Garvit and Karan.</li>
        </ul>
      </section>
    </main>
    <footer>
      <p>Developed by Garvit and Karan</p>
    </footer>
  </div>
  <script>
    // JavaScript code combining auth.js, test.js, leaderboard.js

    // Elements
    const loginSection = document.getElementById('login-section');
    const registerSection = document.getElementById('register-section');
    const testContainer = document.getElementById('test-container');
    const leaderboardSection = document.getElementById('leaderboard-section');
    const aboutSection = document.getElementById('about-section');

    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');

    const loginMessage = document.getElementById('login-message');
    const registerMessage = document.getElementById('register-message');

    const testTextElement = document.getElementById('test-text');
    const inputArea = document.getElementById('input-area');
    const timeLeftElement = document.getElementById('time-left');
    const wpmElement = document.getElementById('wpm');
    const accuracyElement = document.getElementById('accuracy');
    const errorsElement = document.getElementById('errors');
    const restartBtn = document.getElementById('restart-btn');
    const timeOption = document.getElementById('time-option');
    const resultElement = document.getElementById('result');

    const navLogin = document.getElementById('nav-login');
    const navRegister = document.getElementById('nav-register');
    const navLeaderboard = document.getElementById('nav-leaderboard');
    const navAbout = document.getElementById('nav-about');

    const leaderboardTableBody = document.querySelector('#leaderboard-table tbody');

    let timer = null;
    let timeLeft = 60;
    let totalErrors = 0;
    let errors = 0;
    let isTyping = false;
    let typedChars = 0;
    let testText = '';
    let currentUser = null;

    // Show/hide sections
    function showSection(section) {
      loginSection.style.display = 'none';
      registerSection.style.display = 'none';
      testContainer.style.display = 'none';
      leaderboardSection.style.display = 'none';
      aboutSection.style.display = 'none';

      navLogin.classList.remove('active');
      navRegister.classList.remove('active');
      navLeaderboard.classList.remove('active');
      navAbout.classList.remove('active');

      switch (section) {
        case 'login':
          loginSection.style.display = 'block';
          navLogin.classList.add('active');
          showRegisterDetails(false);
          break;
        case 'register':
          registerSection.style.display = 'block';
          navRegister.classList.add('active');
          showRegisterDetails(true);
          break;
        case 'test':
          testContainer.style.display = 'block';
          break;
        case 'leaderboard':
          leaderboardSection.style.display = 'block';
          navLeaderboard.classList.add('active');
          displayLeaderboard();
          break;
        case 'about':
          aboutSection.style.display = 'block';
          navAbout.classList.add('active');
          break;
      }
    }

    navLogin.addEventListener('click', () => showSection('login'));
    navRegister.addEventListener('click', () => showSection('register'));

    // Hide leaderboard and about nav buttons initially
    navLeaderboard.style.display = 'none';
    navAbout.style.display = 'none';

    navLeaderboard.addEventListener('click', () => showSection('leaderboard'));
    navAbout.addEventListener('click', () => showSection('about'));

    // Show/hide login and register details
    // Removed showLoginDetails function and related text as per user request

    function showRegisterDetails(show) {
      let registerDetails = document.getElementById('register-details');
      if (!registerDetails) {
        registerDetails = document.createElement('p');
        registerDetails.id = 'register-details';
        registerDetails.textContent = 'Create a new account by choosing a username and password.';
        registerSection.insertBefore(registerDetails, registerForm);
      }
      registerDetails.style.display = show ? 'block' : 'none';
    }

    // Fetch test text
    function fetchTestText() {
      const duration = parseInt(timeOption.value) || 60;
      fetch(`/api/texts?duration=${duration}`)
        .then(response => response.json())
        .then(data => {
          testText = data.text;
          displayTestText();
        })
        .catch(() => {
          testText = "The quick brown fox jumps over the lazy dog.";
          displayTestText();
        });
    }

    // Display test text
    function displayTestText() {
      testTextElement.innerHTML = '';
      testText.split('').forEach(char => {
        const span = document.createElement('span');
        span.innerText = char;
        testTextElement.appendChild(span);
      });
    }

    // Timer update
    function updateTimer() {
      if (timeLeft > 0) {
        timeLeft--;
        timeLeftElement.innerText = timeLeft;
      } else {
        finishTest();
      }
    }

    // Finish test
    function finishTest() {
      clearInterval(timer);
      inputArea.disabled = true;
      const timeSpent = (parseInt(timeOption.value) - timeLeft);
      const wpm = Math.round(((typedChars / 5) / (timeSpent / 60)) || 0);
      const accuracy = Math.round(((typedChars - totalErrors) / typedChars) * 100) || 0;
      wpmElement.innerText = wpm;
      accuracyElement.innerText = accuracy;
      errorsElement.innerText = totalErrors;

      // Show victory or try again message with icon
      resultElement.innerHTML = '';
      if (wpm >= 40 && accuracy >= 90) {
        resultElement.className = 'result victory';
        resultElement.innerHTML = `
          <svg class="victory-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z" fill="currentColor"/>
          </svg>
          Test finished! Your WPM: ${wpm}, Accuracy: ${accuracy}%. Victory!
        `;
      } else {
        resultElement.className = 'result try-again';
        resultElement.innerHTML = `
          <svg class="try-again-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13l-1.41 1.41L12 13.41l-3.59 3.59L7 15l3.59-3.59L7 7.83 8.41 6.41 12 10l3.59-3.59L17 7.83l-3.59 3.58L17 15z" fill="currentColor"/>
          </svg>
          Test finished! Your WPM: ${wpm}, Accuracy: ${accuracy}%. Try again!
        `;
      }

      saveScore(currentUser, wpm, accuracy, timeSpent);
    }

    // Reset test
    function resetTest() {
      clearInterval(timer);
      timeLeft = parseInt(timeOption.value);
      totalErrors = 0;
      errors = 0;
      isTyping = false;
      typedChars = 0;
      inputArea.disabled = false;
      inputArea.value = '';
      timeLeftElement.innerText = timeLeft;
      wpmElement.innerText = 0;
      accuracyElement.innerText = 100;
      errorsElement.innerText = 0;
      resultElement.innerText = '';
      displayTestText();
    }

    // Input event
    inputArea.addEventListener('input', () => {
      if (!isTyping) {
        isTyping = true;
        timer = setInterval(updateTimer, 1000);
      }

      typedChars = inputArea.value.length;

      const textSpans = testTextElement.querySelectorAll('span');
      errors = 0;

      textSpans.forEach((span, index) => {
        const typedChar = inputArea.value[index];
        if (typedChar == null) {
          span.classList.remove('correct', 'incorrect');
        } else if (typedChar === span.innerText) {
          span.classList.add('correct');
          span.classList.remove('incorrect');
        } else {
          span.classList.add('incorrect');
          span.classList.remove('correct');
          errors++;
        }
      });

      totalErrors = errors;
      errorsElement.innerText = totalErrors;

      const correctChars = typedChars - totalErrors;
      const accuracy = Math.round((correctChars / typedChars) * 100) || 0;
      accuracyElement.innerText = accuracy;

      const timeSpent = (parseInt(timeOption.value) - timeLeft);
      const wpm = Math.round(((correctChars / 5) / (timeSpent / 60)) || 0);
      wpmElement.innerText = wpm;

      if (inputArea.value.length === testText.length) {
        finishTest();
      }
    });

    restartBtn.addEventListener('click', resetTest);

    // Additional elements
    const modeOption = document.getElementById('mode-option');
    const soundToggle = document.getElementById('sound-toggle');
    const raceProgress = document.getElementById('race-progress');
    const opponentProgressBar = document.getElementById('opponent-progress-bar');
    const achievementDisplay = document.getElementById('achievement-display');

    // Sound effects
    const soundKeypress = new Audio('https://actions.google.com/sounds/v1/keyboard/keyboard_press_key.wav');
    const soundError = new Audio('https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg');
    const soundFinish = new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg');

    let raceInterval = null;
    let opponentProgress = 0;
    let currentLevel = 1;
    const maxLevel = 100;

    // Load level from localStorage
    function loadLevel() {
      const savedLevel = localStorage.getItem('typingTestLevel');
      currentLevel = savedLevel ? parseInt(savedLevel) : 1;
      updateAchievementDisplay();
    }

    // Save level to localStorage
    function saveLevel() {
      localStorage.setItem('typingTestLevel', currentLevel.toString());
    }

    // Update achievement display
    function updateAchievementDisplay() {
      achievementDisplay.textContent = `Level: ${currentLevel} / ${maxLevel}`;
    }

    // Simulate opponent progress in race mode
    function startRace() {
      opponentProgress = 0;
      opponentProgressBar.value = 0;
      raceProgress.style.display = 'block';

      // Opponent speed depends on level (higher level, faster opponent)
      const opponentSpeed = 0.5 + (currentLevel / maxLevel) * 1.5; // progress per second

      raceInterval = setInterval(() => {
        opponentProgress += opponentSpeed;
        if (opponentProgress >= 100) {
          opponentProgress = 100;
          clearInterval(raceInterval);
        }
        opponentProgressBar.value = opponentProgress;
      }, 1000);
    }

    // Stop race
    function stopRace() {
      clearInterval(raceInterval);
      raceProgress.style.display = 'none';
      opponentProgressBar.value = 0;
    }

    // Play sound if enabled
    function playSound(sound) {
      if (soundToggle.checked) {
        sound.currentTime = 0;
        sound.play();
      }
    }

    // Override input event to add sound and race progress
    inputArea.removeEventListener('input', inputHandler);
    function inputHandler() {
      if (!isTyping) {
        isTyping = true;
        timer = setInterval(updateTimer, 1000);
        if (modeOption.value === 'race') {
          startRace();
        }
      }

      typedChars = inputArea.value.length;

      const textSpans = testTextElement.querySelectorAll('span');
      errors = 0;

      textSpans.forEach((span, index) => {
        const typedChar = inputArea.value[index];
        if (typedChar == null) {
          span.classList.remove('correct', 'incorrect');
        } else if (typedChar === span.innerText) {
          span.classList.add('correct');
          span.classList.remove('incorrect');
          playSound(soundKeypress);
        } else {
          span.classList.add('incorrect');
          span.classList.remove('correct');
          errors++;
          playSound(soundError);
        }
      });

      totalErrors = errors;
      errorsElement.innerText = totalErrors;

      const correctChars = typedChars - totalErrors;
      const accuracy = Math.round((correctChars / typedChars) * 100) || 0;
      accuracyElement.innerText = accuracy;

      const timeSpent = (parseInt(timeOption.value) - timeLeft);
      const wpm = Math.round(((correctChars / 5) / (timeSpent / 60)) || 0);
      wpmElement.innerText = wpm;

      if (inputArea.value.length === testText.length) {
        finishTest();
      }
    }
    inputArea.addEventListener('input', inputHandler);

    // Override finishTest to add race and achievement logic
    const originalFinishTest = finishTest;
    finishTest = function() {
      originalFinishTest();

      if (modeOption.value === 'race') {
        stopRace();
        const userProgress = (typedChars / testText.length) * 100;
        const opponentFinished = opponentProgress >= 100;
        let raceResult = '';
        if (userProgress >= 100 && (!opponentFinished || wpmElement.innerText >= opponentProgressBar.value)) {
          raceResult = 'You won the race! 🎉';
          if (currentLevel < maxLevel) {
            currentLevel++;
            saveLevel();
            updateAchievementDisplay();
          }
        } else {
          raceResult = 'You lost the race. Try again!';
          if (currentLevel > 1) {
            currentLevel--;
            saveLevel();
            updateAchievementDisplay();
          }
        }
        resultElement.innerText += `\n${raceResult}`;
      } else {
        // Update level on normal mode finishTest
        if (currentLevel < maxLevel) {
          currentLevel++;
          saveLevel();
          updateAchievementDisplay();
        }
      }

      playSound(soundFinish);
    };

    // Initialize level on page load
    loadLevel();

    // Re-add themeSelector event listener for dynamic theme changes
    const themeSelector = document.getElementById('theme');
    if (themeSelector) {
      themeSelector.addEventListener('change', (e) => {
        document.body.className = '';
        document.body.classList.add(`theme-${e.target.value}`);
      });
    }

    // Leaderboard functions
    function saveScore(username, wpm, accuracy, timeSpent) {
      if (!username) return;
      let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
      leaderboard.push({ username, wpm, accuracy, timeSpent });
      leaderboard.sort((a, b) => b.wpm - a.wpm || b.accuracy - a.accuracy);
      leaderboard = leaderboard.slice(0, 10);
      localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
    }

    function displayLeaderboard() {
      let leaderboard = JSON.parse(localStorage.getItem('leaderboard')) || [];
      leaderboardTableBody.innerHTML = '';
      leaderboard.forEach((entry, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${entry.username}</td>
          <td>${entry.wpm}</td>
          <td>${entry.accuracy}%</td>
          <td>${entry.timeSpent}s</td>
        `;
        leaderboardTableBody.appendChild(tr);
      });
    }

    // Login form submit
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const theme = document.getElementById('login-theme').value;

      if (!username || !password) {
        loginMessage.innerText = 'Please enter username and password.';
        loginMessage.style.color = 'red';
        return;
      }

      try {
        const response = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'login', username, password, theme }),
        });
        const data = await response.json();

        if (response.ok) {
          loginMessage.style.color = 'green';
          loginMessage.innerText = data.message;
          currentUser = username;
          // Show authenticated area and hide login/register
          document.getElementById('authenticated-area').style.display = 'block';
          loginSection.style.display = 'none';
          registerSection.style.display = 'none';

          // Show leaderboard and about nav buttons after login
          navLeaderboard.style.display = 'inline-block';
          navAbout.style.display = 'inline-block';

          // Apply selected theme
          document.body.className = '';
          document.body.classList.add(`theme-${theme}`);

          // Update nav active states
          navLogin.classList.remove('active');
          navRegister.classList.remove('active');
          navLeaderboard.classList.remove('active');
          navAbout.classList.remove('active');
          // Show test container
          showSection('test');
          fetchTestText();
        } else {
          loginMessage.style.color = 'red';
          loginMessage.innerText = data.error || 'Login failed.';
        }
      } catch (error) {
        loginMessage.style.color = 'red';
        loginMessage.innerText = 'Error connecting to server.';
      }
    });

    // Register form submit
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value.trim();
      const theme = document.getElementById('register-theme').value;

      if (!username || !password) {
        registerMessage.innerText = 'Please enter username and password.';
        registerMessage.style.color = 'red';
        return;
      }

      try {
        const response = await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'register', username, password, theme }),
        });
        const data = await response.json();

        if (response.ok) {
          registerMessage.style.color = 'green';
          registerMessage.innerText = data.message + ' Please login now.';
          showSection('login');
        } else {
          registerMessage.style.color = 'red';
          registerMessage.innerText = data.error || 'Registration failed.';
        }
      } catch (error) {
        registerMessage.style.color = 'red';
        registerMessage.innerText = 'Error connecting to server.';
      }
    });

    // Initialize
    showSection('login');
    // Removed showLoginDetails call as text is removed
    showRegisterDetails(false);
  </script>
</body>
</html>
